# Backend (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

## üìå ‚úÖ –û–±—â–∏–π —Å—Ç–µ–∫
- **Django 4.x**
- **Django REST Framework**
- **Celery + Redis** (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
- **PostgreSQL**
- **Docker**

## ‚úÖ A. Apps –∏ –∏—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

### üü¢ users
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º telegram_id, username)
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, —Ñ–∞–º–∏–ª–∏—è, –∏–Ω—Ç–µ—Ä–µ—Å—ã, —Å—Ñ–µ—Ä–∞)
- –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (–∞–≤–∞—Ç–∞—Ä)
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –°–≤—è–∑–∏ (–¥—Ä—É–∑—å—è, Circle)

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –≤—Ö–æ–¥
- –ü–æ–ª—è –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (—Å—Ñ–µ—Ä–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å

### üü¢ tours
- –¢—É—Ä –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç
- –°–µ—Å—Å–∏–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã —Ç—É—Ä–∞)
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–∏–ø—ã —Ç—É—Ä–æ–≤
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ–ø—Ü–∏–∏ —Ç—É—Ä–∞
- –§–æ—Ç–æ –∏ –≥–∞–ª–µ—Ä–µ–∏
- –ß–∞—Ç—ã —Ç—É—Ä–∞
- –ê–∫—Ü–∏–∏/—Å–∫–∏–¥–∫–∏/–ø—Ä–æ–º–æ–∫–æ–¥—ã

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –ì–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Ç–∏–ø —Ç—É—Ä–∞ ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
- JSONField –¥–ª—è –æ–ø—Ü–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
- ManyToMany —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç—É—Ä–∞
- –¢—É—Ä-—Å–µ—Å—Å–∏–∏ —Å –¥–∞—Ç–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∫–∏–¥–æ–∫ (Promotion) –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (PromoCode)

### üü¢ bookings
- –ó–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å (requested / approved / paid / cancelled / expired)
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ TourSession
- –ü–æ–ª–µ promo_code
- –£—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ–Ω—É—Å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–∫–∏–¥–æ–∫
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –±—Ä–æ–Ω–∏
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram-–±–æ—Ç–æ–º –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –õ–æ–≥–∏–∫–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ (60 –º–∏–Ω)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
- –°–≤—è–∑—å —Å –æ–ø–ª–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç—É—Å paid

### üü¢ payments
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –£—á—ë—Ç –≤—Ö–æ–¥—è—â–∏—Ö –æ–ø–ª–∞—Ç —á–µ—Ä–µ–∑ Payme
- –£—á—ë—Ç –≤—ã–ø–ª–∞—Ç (Payme Payout)
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á—ë—Ç –∫–æ–º–∏—Å—Å–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- Split-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–Ω–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É)
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ Booking
- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –ü–æ–ª—è Payme Invoice ID
- –°—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤

### üü¢ agencies
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞—Ö
- –ö–æ–Ω—Ç–∞–∫—Ç—ã, –æ–ø–∏—Å–∞–Ω–∏–µ
- –õ–æ–≥–æ—Ç–∏–ø
- Payme Merchant ID
- –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏
- –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –í–∏–¥–∏–º–æ—Å—Ç—å —Ç—É—Ä–æ–≤ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
- –°—á–µ—Ç –¥–ª—è –ø—Ä–∏—ë–º–∞ –æ–ø–ª–∞—Ç

### üü¢ referrals
- –£—á—ë—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤/–±–ª–æ–≥–µ—Ä–æ–≤
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
- –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π
- –ë–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
- –õ–æ–≥ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–ø–ª–∞—Ç

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Payme
- –ó–∞–¥–µ—Ä–∂–∫–∞ 7 –¥–Ω–µ–π –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –±–æ–Ω—É—Å–æ–≤
- –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ –∑–∞–∫–∞–∑–∞–º

### üü¢ media
- –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
- –§–æ—Ç–æ —Ç—É—Ä–æ–≤
- –ì–∞–ª–µ—Ä–µ–∏
- –õ–æ–≥–æ—Ç–∏–ø—ã –∞–≥–µ–Ω—Ç—Å—Ç–≤
- –ê–≤–∞—Ç–∞—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ FileField
- –°–∞–º–∏ —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ/–æ–±–ª–∞–∫–µ

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –°—Å—ã–ª–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î
- –°–∞–º–∏ –º–µ–¥–∏–∞ ‚Äî –≤–Ω–µ –ë–î (—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞/S3)

### üü¢ core
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–≤ –±—É–¥—É—â–µ–º)
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
- –•—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–∞ —Å–æ–±—ã—Ç–∏–π (user_id, role, action, details)

**‚úÖ –í–∞–∂–Ω–æ–µ:**
- –î–ª—è –∞—É–¥–∏—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –ó–∞–ø–∏—Å–∏ —Å timestamp

## ‚úÖ B. –ö–ª—é—á–µ–≤—ã–µ –º–æ–¥–µ–ª–∏ (—Å–≤–æ–¥–Ω–æ)

### ‚úÖ User
- telegram_id
- username
- –∏–º—è, —Ñ–∞–º–∏–ª–∏—è
- –∞–≤–∞—Ç–∞—Ä
- –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤

### ‚úÖ TravelAgency
- name
- description
- payme_merchant_id
- commission_percent

### ‚úÖ Tour
- title, description
- category
- parameters (JSON)
- agency
- transport_options
- gallery
- participants

### ‚úÖ TourSession
- tour
- date_start, date_end
- price
- available_seats
- promotions
- promo_codes

### ‚úÖ Promotion
- session
- discount_percent / discount_amount
- validity

### ‚úÖ PromoCode
- code
- session
- discount
- usage_limit

### ‚úÖ Booking
- user
- session
- seats_reserved
- selected_transport
- promo_code
- final_price
- status (requested/approved/paid/etc)
- approved_by
- expires_at
- comment

### ‚úÖ PaymentTransaction
- booking
- agency
- amount
- payme_invoice_id
- status

### ‚úÖ AccountingTransaction
- agency
- amount
- type (commission, payout)
- status

### ‚úÖ ReferralPartner
- user
- code
- commission_percent
- total_sales
- total_commission_paid
- is_active

### ‚úÖ ReferralBonus
- user
- amount
- status (pending/available/withdrawn)
- available_at

### ‚úÖ ReferralPayoutRequest
- user
- amount
- card_number
- status

### ‚úÖ Media
- file
- uploader
- type

### ‚úÖ Core.Log
- user_id
- role
- action
- details
- timestamp

## ‚úÖ C. –û—Å–Ω–æ–≤–Ω—ã–µ API endpoints (–ø—Ä–∏–º–µ—Ä—ã)

### ‚úÖ /api/users/
- register/
- profile/
- update/
- avatar/

### ‚úÖ /api/tours/
- list/
- detail/{id}/
- sessions/
- promotions/
- promo-codes/

### ‚úÖ /api/bookings/
- POST (—Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É)
- /my/ (–º–æ–∏ –∑–∞—è–≤–∫–∏)
- /pending/ (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤)
- /{id}/approve/
- /{id}/reject/

### ‚úÖ /api/payments/
- transactions/
- payout-requests/

### ‚úÖ /api/agencies/
- list/
- detail/
- create/
- update/

### ‚úÖ /api/referrals/
- partners/
- bonuses/
- payout-requests/

### ‚úÖ /api/media/
- upload/
- list/
- delete/

### ‚úÖ /api/core/
- logs/

## ‚úÖ D. –ü—Ä–∏–º–µ—Ä—ã —Ñ–ª–æ—É

### ‚úÖ –§–ª–æ—É 1: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Telegram WebApp
2. –í—ã–±–∏—Ä–∞–µ—Ç —Ç—É—Ä –∏ —Å–µ—Å—Å–∏—é (–¥–∞—Ç—É)
3. –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞—è–≤–∫—É (Booking —Å —Å—Ç–∞—Ç—É—Å–æ–º requested)
4. –ú–µ–Ω–µ–¥–∂–µ—Ä –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –≤–∏–¥–∏—Ç –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç/–∞–¥–º–∏–Ω–∫—É
5. –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Üí Approve ‚Üí —Å—Ç–∞—Ç—É—Å = approved
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç (Payme –∏–Ω–≤–æ–π—Å)
8. Backend —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç PaymentTransaction
9. –°—Ç–∞—Ç—É—Å Booking = paid

### ‚úÖ –§–ª–æ—É 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç PromoCode (–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å, –ª–∏–º–∏—Ç—ã)
3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫—É
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç promo_code –≤ Booking
5. –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫—É

### ‚úÖ –§–ª–æ—É 3: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—Ä–æ–Ω–∏—Ä—É–µ—Ç –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–≤—è–∑—å Booking ‚Üí ReferralPartner
3. –ù–∞ –∞–∫–∫–∞—É–Ω—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è ReferralBonus (pending)
4. –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π ‚Üí status = available
5. –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
6. –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí Payme Payout
7. –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ = –í—ã–ø–ª–∞—á–µ–Ω–æ

### ‚úÖ –§–ª–æ—É 4: –ó–∞—è–≤–∫–∞ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç—É—Ä (V2)
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è CustomTripRequest
3. –ê–≥–µ–Ω—Ç—Å—Ç–≤–∞ –≤–∏–¥—è—Ç –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
4. –û—Ç–≤–µ—á–∞—é—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç
6. –°–æ–∑–¥–∞–µ—Ç—Å—è Booking

## ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ:

> **¬´Backend Circle —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ –º–æ–¥—É–ª–∏ (users, tours, bookings, payments –∏ –¥—Ä.), –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –Ω–∞ PostgreSQL –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç REST API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞ –∏ Telegram-–±–æ—Ç–∞. –õ–æ–≥–∏–∫–∞ –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ Payme, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞–º–∏, –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞–º–∏, —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ –∏ –±–æ–Ω—É—Å–∞–º–∏.¬ª** 